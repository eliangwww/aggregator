name: Refresh
on:
  # æ¯ä¸¤å°æ—¶æ‰§è¡Œä¸€æ¬¡
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.repository }}
  cancel-in-progress: true

env:
  # è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
  TZ: Asia/Shanghai

  # github access token
  GIST_PAT: ${{ secrets.GIST_PAT }}

  # Gist é“¾æ¥ï¼ŒåŒ…å«ç”¨æˆ·åå’Œ Gist ID
  GIST_LINK: ${{ secrets.GIST_LINK }}

  # è‡ªå®šä¹‰é“¾æ¥
  CUSTOMIZE_LINK: ${{ secrets.CUSTOMIZE_LINK }}

  # å¯ç”¨ç‰¹æ®Šåè®®
  ENABLE_SPECIAL_PROTOCOLS: ${{ vars.ENABLE_SPECIAL_PROTOCOLS }}

  # Telegram bot token and chat id
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Prepare
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"
          cache: "pip"

      - name: Install
        run: |
          pip3 install -r requirements.txt
          pip3 install python-telegram-bot pyyaml

      - name: Check
        run: |
          if [ -z "$GIST_PAT" ]; then
              echo "Error: environment 'GIST_PAT' cannot be empty"
              exit 1
          fi

          if [ -z "$GIST_LINK" ]; then
              echo "Error: environment 'GIST_LINK' cannot be empty"
              exit 1
          fi

          LINK_PARTS=$(echo "$GIST_LINK" | awk -F'/' 'NF==2 && $1!="" && $2!=""')
          if [ -z "$LINK_PARTS" ]; then
              echo "Error: environment 'GIST_LINK' is not valid, should be 'username/gist_id' format"
              exit 1
          fi

      - name: Refresh
        run: python -u subscribe/collect.py -t clash mixed --all --refresh --overwrite --skip

      - name: Timestamp
        run: date

      - name: Notify
        env:
          GIST_FILE_URL: "https://gist.githubusercontent.com/${{ env.GIST_LINK }}/raw/clash.yaml"
        run: |
          python3 <<EOF
import os
import yaml
import requests
from datetime import datetime
from telegram import Bot
import pytz

# è®¾ç½® Telegram Bot
TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
CHAT_ID = os.getenv('TELEGRAM_CHAT_ID')
bot = Bot(token=TOKEN)

# è·å–åŒ—äº¬æ—¶é—´
beijing = pytz.timezone('Asia/Shanghai')
update_time = datetime.now(beijing).strftime('%Y-%m-%d %H:%M:%S')

# ä¸‹è½½å¹¶è§£æ Gist æ–‡ä»¶
url = os.getenv('GIST_FILE_URL')
response = requests.get(url)
data = yaml.safe_load(response.text)

# è§£æèŠ‚ç‚¹æ•°é‡å’Œåœ°åŒº
node_count = len(data['proxies'])
regions = set()
for proxy in data['proxies']:
    if 'name' in proxy and proxy['name'][0] in ["ğŸ‡ºğŸ‡¸", "ğŸ‡¬ğŸ‡§", "ğŸ‡¨ğŸ‡³", "ğŸ‡¯ğŸ‡µ"]:  # ä½ å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»–æ——å¸œ
        regions.add(proxy['name'][0])

# ç”Ÿæˆæ¶ˆæ¯å†…å®¹
message = f"""
æ›´æ–°æ—¶é—´: {update_time} (åŒ—äº¬æ—¶é—´)
èŠ‚ç‚¹æ•°é‡: {node_count}
èŠ‚ç‚¹åœ°åŒº: {', '.join(regions)}
"""

# å‘é€ Telegram æ¶ˆæ¯
bot.send_message(chat_id=CHAT_ID, text=message)
EOF
